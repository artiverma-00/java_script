<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Books (Realtime DB)</title>
  <style>
    /* Minimal styles for demonstration */
    body{font-family:Inter,system-ui; padding:18px; background:#f7fafc}
    .card{background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.04);margin-bottom:12px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:600px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <h2>Books — Realtime Database</h2>

  <div style="margin-bottom:12px">
    <input id="title" placeholder="Title"/>
    <input id="author" placeholder="Author"/>
    <input id="price" placeholder="Price"/>
    <input id="image" placeholder="Cover Image URL"/>
    <button id="addBtn">Add Book</button>
    <input id="search" placeholder="Search by title or author" style="margin-left:12px"/>
  </div>

  <div id="grid" class="grid"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      set,
      onValue,
      update,
      remove,
      query,
      orderByChild
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // ======== REPLACE with your Firebase config ========
    const firebaseConfig = {
      apiKey: "REPLACE_ME",
      authDomain: "REPLACE_ME",
      databaseURL: "https://books-44b2f-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "REPLACE_ME",
      storageBucket: "REPLACE_ME",
      messagingSenderId: "REPLACE_ME",
      appId: "REPLACE_ME"
    };
    // ==================================================

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // We'll keep books under '/books' path
    const booksRef = ref(db, 'books/');

    // DOM refs
    const titleEl = document.getElementById('title');
    const authorEl = document.getElementById('author');
    const priceEl = document.getElementById('price');
    const imageEl = document.getElementById('image');
    const addBtn = document.getElementById('addBtn');
    const grid = document.getElementById('grid');
    const search = document.getElementById('search');

    // Local mirror for search
    let books = {}; // key -> bookObj

    // Real-time listener: fires whenever /books changes
    onValue(booksRef, (snapshot) => {
      const val = snapshot.val() || {};
      books = val;
      renderGrid(search.value || '');
    }, (error) => {
      console.error('onValue error', error);
      alert('Realtime listener error — check Firebase rules & console.');
    });

    // Add new book
    addBtn.addEventListener('click', async () => {
      const title = (titleEl.value || '').trim();
      const author = (authorEl.value || '').trim();
      const price = (priceEl.value || '').trim();
      const image = (imageEl.value || '').trim();

      if (!title) { alert('Enter title'); return; }
      if (!author) { alert('Enter author'); return; }

      // push() generates a unique child key
      const newBookRef = push(booksRef);
      const bookObj = { title, author, price: price || '0.00', coverImageURL: image || '' };

      try {
        await set(newBookRef, bookObj);
        titleEl.value = authorEl.value = priceEl.value = imageEl.value = '';
      } catch (err) {
        console.error('Add book failed', err);
        alert('Failed to add book — see console.');
      }
    });

    // Render grid (filter by q)
    function renderGrid(q = '') {
      // clear
      while (grid.firstChild) grid.removeChild(grid.firstChild);

      const ql = q.trim().toLowerCase();

      const entries = Object.entries(books); // [ [key, obj], ... ]
      const visible = entries.filter(([k, b]) => {
        if (!ql) return true;
        return (b.title && b.title.toLowerCase().includes(ql)) ||
               (b.author && b.author.toLowerCase().includes(ql));
      });

      if (visible.length === 0) {
        const div = document.createElement('div'); div.className='card'; div.textContent='No books found';
        grid.appendChild(div);
        return;
      }

      visible.forEach(([key, b]) => {
        const card = document.createElement('div'); card.className = 'card';
        const h = document.createElement('h4'); h.textContent = b.title; card.appendChild(h);
        const p = document.createElement('p'); p.textContent = 'By ' + (b.author || '—'); card.appendChild(p);
        const price = document.createElement('div'); price.textContent = b.price ? '$' + Number(b.price).toFixed(2) : 'Free'; card.appendChild(price);

        const actions = document.createElement('div');
        const upd = document.createElement('button'); upd.textContent = 'Update Author';
        upd.addEventListener('click', async () => {
          const newAuthor = prompt('New author name', b.author || '');
          if (newAuthor === null) return;
          if (newAuthor.trim() === '') { alert('Author cannot be empty'); return; }
          try {
            await update(ref(db, 'books/' + key), { author: newAuthor.trim() });
          } catch (err) { console.error(err); alert('Update failed'); }
        });

        const del = document.createElement('button'); del.textContent = 'Delete';
        del.addEventListener('click', async () => {
          if (!confirm('Delete this book?')) return;
          try {
            await remove(ref(db, 'books/' + key));
          } catch (err) { console.error(err); alert('Delete failed'); }
        });

        const view = document.createElement('button'); view.textContent = 'View';
        view.addEventListener('click', () => {
          alert(JSON.stringify(b, null, 2));
        });

        actions.appendChild(view); actions.appendChild(upd); actions.appendChild(del);
        card.appendChild(actions);

        grid.appendChild(card);
      });
    }

    // search real-time
    search.addEventListener('input', (e) => {
      renderGrid(e.target.value);
    });

  </script>
</body>
</html>
